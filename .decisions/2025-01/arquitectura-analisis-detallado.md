# üèóÔ∏è An√°lisis Arquitect√≥nico Detallado - extract-pdf-data

**Fecha:** 2025-10-25
**Autor:** Claude Code + Equipo
**Estado:** Completado
**Relacionado con:** ADR-001, Issue #7

---

## üìã Resumen Ejecutivo

### Estado Actual: **Bueno (7/10)**

**Fortalezas:**
- ‚úÖ C√≥digo funcional con 79% coverage
- ‚úÖ 154 tests pasando (2 skipped)
- ‚úÖ Separaci√≥n b√°sica de responsabilidades
- ‚úÖ Tests bien estructurados con fixtures compartidas

**Debilidades:**
- ‚ùå Sin logging estructurado (solo `print()`)
- ‚ùå L√≥gica de negocio en main.py
- ‚ùå Duplicaci√≥n menor de c√≥digo
- ‚ùå Responsabilidades mezcladas en m√≥dulos

**Recomendaci√≥n:** Refactorizaci√≥n pragm√°tica incremental (10-12 horas de inversi√≥n)

---

## 1. ESTRUCTURA ACTUAL

### M√≥dulos en `src/`

```
src/
‚îú‚îÄ‚îÄ main.py              (212 statements, 91% coverage)
‚îú‚îÄ‚îÄ pdf_extractor.py     (294 statements, 91% coverage)
‚îú‚îÄ‚îÄ excel_exporter.py    (241 statements, 81% coverage)
‚îî‚îÄ‚îÄ editor_plantillas.py (332 statements, 58% coverage)
```

### Responsabilidades por M√≥dulo

#### **main.py - FacturaExtractorApp**
**L√≠neas:** 320 | **Coverage:** 91%

**Responsabilidades (mezcladas):**
- ‚úÖ Orquestaci√≥n del flujo (CLI + Interactivo)
- ‚ö†Ô∏è Validaci√≥n de entrada (deber√≠a ser en validator)
- ‚ö†Ô∏è Verificaci√≥n de estructura del proyecto
- ‚úÖ Coordinaci√≥n entre PDFExtractor y ExcelExporter
- ‚úÖ Mostrar estad√≠sticas y banners

**Problemas:**
- Hace demasiadas cosas (validaci√≥n + orquestaci√≥n + UI)
- Dif√≠cil testear l√≥gica de validaci√≥n por separado
- No hay separaci√≥n clara entre CLI y l√≥gica

---

#### **pdf_extractor.py - PDFExtractor**
**L√≠neas:** 631 | **Coverage:** 91%

**Responsabilidades (mezcladas):**
- ‚úÖ Carga y validaci√≥n de plantillas JSON
- ‚úÖ Identificaci√≥n autom√°tica de proveedores
- ‚ö†Ô∏è Extracci√≥n de texto de PDFs (I/O + procesamiento)
- ‚ö†Ô∏è Limpieza de datos (deber√≠a ser utils separado)
- ‚úÖ Detecci√≥n de duplicados
- ‚ö†Ô∏è Generaci√≥n de estad√≠sticas (deber√≠a ser en service)

**Funciones Largas:**
- `procesar_directorio_facturas()`: ~94 l√≠neas (ALTA complejidad)
- `extraer_datos_factura()`: ~89 l√≠neas (MEDIA complejidad)
- `limpiar_fecha()`: ~51 l√≠neas (MEDIA complejidad, pero bien documentada)

**Problemas:**
- Mezcla I/O (cargar plantillas) con l√≥gica de negocio
- Limpieza de datos deber√≠a estar en utils
- Estad√≠sticas deber√≠an ser en service separado

---

#### **excel_exporter.py - ExcelExporter**
**L√≠neas:** 528 | **Coverage:** 81%

**Responsabilidades (mezcladas):**
- ‚úÖ Exportaci√≥n a Excel (3 variantes: b√°sico, completo, formateado)
- ‚úÖ Exportaci√≥n a CSV y JSON
- ‚ö†Ô∏è Formateo de hojas con estilos (deber√≠a ser formatter)
- ‚ö†Ô∏è Filtrado de columnas (duplicado en m√∫ltiples m√©todos)
- ‚ö†Ô∏è Estad√≠sticas por proveedor y por campo (deber√≠a ser service)

**Funciones Largas:**
- `exportar_excel_formateado()`: ~46 l√≠neas (MEDIA-ALTA)
- `_crear_hoja_resumen()`: ~67 l√≠neas (MEDIA-ALTA)

**Duplicaci√≥n Significativa:**
```python
# Se repite en 5 lugares diferentes:
datos_estandar = self._filtrar_columnas_estandar(...)
```

**Problemas:**
- Mezcla exportaci√≥n + formateo + estad√≠sticas
- Duplicaci√≥n de filtrado de columnas
- Pattern Strategy incipiente pero sin interfaz com√∫n

---

#### **editor_plantillas.py - EditorPlantillas**
**L√≠neas:** 619 | **Coverage:** 58%

**Responsabilidades (adecuadas para GUI):**
- ‚úÖ GUI Tkinter para capturar coordenadas
- ‚úÖ Carga/edici√≥n de plantillas existentes
- ‚úÖ Persistencia JSON
- ‚úÖ Visualizaci√≥n con Pillow

**Problemas:**
- Coverage bajo (58%) pero ESPERADO para GUI
- Dif√≠cil testear eventos de UI (mouse, drag, etc.)
- L√≥gica de negocio bien separada y testeada

**Nota:** Este m√≥dulo est√° bien para ser GUI. No requiere cambios mayores.

---

## 2. PATRONES DE DISE√ëO ACTUALES

### Patrones Identificables

| Patr√≥n | Ubicaci√≥n | Evaluaci√≥n | Acci√≥n |
|--------|-----------|-----------|--------|
| **Singleton impl√≠cito** | FacturaExtractorApp | ‚úÖ Bien usado | Mantener |
| **Repository-like** | PDFExtractor.cargar_plantillas() | ‚ö†Ô∏è Parcial | Mejorar |
| **Template Method** | ExcelExporter (3 exportadores) | ‚ùå D√©bil - duplicaci√≥n | Refactorizar |
| **Strategy** | Exporters (excel, csv, json) | ‚ö†Ô∏è Incipiente | Formalizar |
| **Builder** | EditorPlantillas | ‚úÖ Impl√≠cito | Mantener |

### Acoplamiento Actual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             main.py                      ‚îÇ
‚îÇ        (Orquestador)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ              ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇPDFExtractor‚îÇ   ‚îÇ ExcelExporter  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ             ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ   Librer√≠as externas      ‚îÇ
    ‚îÇ pdfplumber, pandas, etc.  ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Evaluaci√≥n:** Acoplamiento entre m√≥dulos principales es **bajo** (bueno), pero acoplamiento interno es **medio-alto** (mejorable).

---

## 3. AN√ÅLISIS DE CALIDAD

### 3.1 Funciones Complejas

| Funci√≥n | M√≥dulo | L√≠neas | Complejidad | Acci√≥n Sugerida |
|---------|--------|--------|-------------|----------------|
| `procesar_directorio_facturas()` | pdf_extractor.py | 94 | ALTA | Dividir en m√©todos |
| `exportar_excel_formateado()` | excel_exporter.py | 46 | MEDIA-ALTA | Extraer formatters |
| `_crear_hoja_resumen()` | excel_exporter.py | 67 | MEDIA-ALTA | Extraer calculadores |
| `extraer_datos_factura()` | pdf_extractor.py | 89 | MEDIA | Dividir responsabilidades |
| `limpiar_fecha()` | pdf_extractor.py | 51 | MEDIA | Mover a utils |

**Nota:** Ninguna funci√≥n es cr√≠tica, pero hay espacio para mejoras.

---

### 3.2 Duplicaci√≥n de C√≥digo

#### **Duplicaci√≥n Alta:**

**1. Filtrado de columnas** (5 ubicaciones)
```python
# excel_exporter.py - l√≠neas 32, 79, 139, 403, 432
datos_estandar = self._filtrar_columnas_estandar(datos, excluir_duplicados, excluir_errores)
```

**Impacto:** Cambios en filtrado requieren modificar 5 lugares.

**Soluci√≥n:**
```python
def _export_generic(self, data, format, exclude_dups=True, exclude_errors=True):
    filtered = self._filtrar_columnas_estandar(data, exclude_dups, exclude_errors)
    # Export seg√∫n format
```

---

**2. Inicializaci√≥n de datos con errores** (2 ubicaciones)
```python
# pdf_extractor.py - l√≠neas 513, 534
datos_error = {
    'CIF': '',
    'FechaFactura': '',
    'Trimestre': self.trimestre,
    'A√±o': self.anio,
    # ... 6 campos m√°s
}
```

**Impacto:** A√±adir un campo requiere 2 cambios.

**Soluci√≥n:**
```python
def _create_empty_invoice_data(self) -> dict:
    return {
        'CIF': '',
        'FechaFactura': '',
        # ...
    }
```

---

**3. Formateo de bordes en Excel** (m√∫ltiple)
```python
# excel_exporter.py - l√≠neas 254-259, 264-269
cell.border = Border(
    left=Side(style='thin'),
    right=Side(style='thin'),
    top=Side(style='thin'),
    bottom=Side(style='thin')
)
```

**Soluci√≥n:**
```python
def _apply_thin_border(self, cell):
    cell.border = self.THIN_BORDER  # Constante
```

---

### 3.3 Manejo de Errores

#### Fortalezas:
- ‚úÖ Try-except en puntos cr√≠ticos
- ‚úÖ Errores registrados en metadatos (`_Error`)
- ‚úÖ Validaci√≥n de entrada de usuario

#### Debilidades:
```python
# Problema 1: Excepciones gen√©ricas
try:
    # ... c√≥digo
except Exception as e:  # ‚ùå Demasiado amplio
    print(f"Error: {e}")

# Problema 2: Manejo inconsistente
try:
    # ... 40+ l√≠neas
except Exception as e:
    print(f"Error: {e}")  # ‚ùå No hay recovery
    datos['_Error'] = str(e)

# Problema 3: Errores silenciosos en Excel
try:
    # ... formateo
except:  # ‚ùå Bare except
    pass  # ‚ùå Error silencioso
```

**Soluciones:**
1. Excepciones espec√≠ficas (`FileNotFoundError`, `ValueError`, etc.)
2. Logging estructurado en lugar de `print()`
3. Recovery strategies donde sea posible
4. No usar bare `except`

---

### 3.4 Logging Actual

**Estado:** ‚ùå No existe logging formal

```python
# Actual (en todo el c√≥digo):
print(f"OK Plantilla cargada: {archivo}")
print(f"WARN Plantilla invalida: {archivo}")
print(f"Error cargando plantilla {archivo}: {e}")
```

**Problemas:**
- ‚ùå No se puede capturar o redirigir logs
- ‚ùå Sin timestamps
- ‚ùå Sin niveles (DEBUG, INFO, WARNING, ERROR)
- ‚ùå Mezclado con output de usuario
- ‚ùå Imposible debuggear en producci√≥n

**Soluci√≥n:**
```python
import logging

logger = logging.getLogger(__name__)

logger.info("Plantilla cargada: %s", archivo)
logger.warning("Plantilla inv√°lida: %s", archivo)
logger.error("Error cargando plantilla %s: %s", archivo, e)
```

---

## 4. OPORTUNIDADES DE MEJORA

### 4.1 Logging Estructurado

**Esfuerzo:** Bajo (1-2 horas)
**Impacto:** Alto
**Prioridad:** ‚≠ê‚≠ê‚≠ê CR√çTICA

**Implementaci√≥n:**
```python
# src/utils/logger.py
import logging
import sys

def setup_logger(name: str, level: int = logging.INFO) -> logging.Logger:
    """Configura logger estructurado."""
    logger = logging.getLogger(name)
    logger.setLevel(level)

    # Handler para consola
    handler = logging.StreamHandler(sys.stdout)
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    handler.setFormatter(formatter)
    logger.addHandler(handler)

    return logger

# Uso en cada m√≥dulo:
from utils.logger import setup_logger
logger = setup_logger(__name__)

logger.info("Procesando %d facturas", len(facturas))
logger.error("Error procesando %s: %s", archivo, e)
```

**Beneficios:**
- Debuggeo en producci√≥n
- Logs redirigibles a archivo
- Niveles configurables (DEBUG en dev, INFO en prod)
- Timestamps autom√°ticos

---

### 4.2 Extraer Limpiadores de Datos

**Esfuerzo:** Bajo (1-2 horas)
**Impacto:** Medio
**Prioridad:** ‚≠ê‚≠ê‚≠ê ALTA

**Implementaci√≥n:**
```python
# src/utils/data_cleaners.py
import re
from datetime import datetime
from typing import Optional

class DataCleaner:
    """Limpieza y normalizaci√≥n de datos extra√≠dos."""

    @staticmethod
    def clean_text(text: str) -> str:
        """Limpia espacios y caracteres especiales."""
        if not text:
            return ""
        return re.sub(r'\s+', ' ', text).strip()

    @staticmethod
    def clean_date(text: str) -> str:
        """
        Normaliza fechas a formato DD/MM/YYYY.

        Soporta:
        - DD/MM/YYYY
        - YYYY-MM-DD
        - DD-MM-YYYY
        - Texto: "15 de enero de 2024"
        """
        # ... l√≥gica actual de limpiar_fecha()
        pass

    @staticmethod
    def clean_numeric(text: str) -> str:
        """Limpia y normaliza n√∫meros."""
        # ... l√≥gica actual de limpiar_numerico()
        pass

# Uso en pdf_extractor.py:
from utils.data_cleaners import DataCleaner

texto_limpio = DataCleaner.clean_text(texto_crudo)
fecha_limpia = DataCleaner.clean_date(fecha_cruda)
numero_limpio = DataCleaner.clean_numeric(numero_crudo)
```

**Beneficios:**
- Reutilizaci√≥n en otros m√≥dulos
- Testeable independientemente
- M√°s f√°cil de mantener
- Reduce complejidad de PDFExtractor

---

### 4.3 Repository Pattern

**Esfuerzo:** Medio (2-3 horas)
**Impacto:** Alto
**Prioridad:** ‚≠ê‚≠ê MEDIA-ALTA

**Implementaci√≥n:**
```python
# src/repositories/template_repository.py
from typing import Dict, List, Optional
import json
from pathlib import Path

class TemplateRepository:
    """Repositorio para cargar y gestionar plantillas JSON."""

    def __init__(self, templates_dir: str = "plantillas"):
        self.templates_dir = Path(templates_dir)

    def load_all(self) -> Dict[str, dict]:
        """Carga todas las plantillas del directorio."""
        templates = {}
        for file in self.templates_dir.glob("*.json"):
            template = self.load_one(file.stem)
            if template:
                templates[file.stem] = template
        return templates

    def load_one(self, name: str) -> Optional[dict]:
        """Carga una plantilla espec√≠fica."""
        path = self.templates_dir / f"{name}.json"
        try:
            with open(path, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            logger.error("Error cargando plantilla %s: %s", name, e)
            return None

    def validate(self, template: dict) -> bool:
        """Valida estructura de plantilla."""
        # ... l√≥gica de validar_plantilla()
        pass

    def save(self, name: str, template: dict) -> bool:
        """Guarda plantilla a disco."""
        path = self.templates_dir / f"{name}.json"
        try:
            with open(path, 'w', encoding='utf-8') as f:
                json.dump(template, f, indent=2, ensure_ascii=False)
            return True
        except Exception as e:
            logger.error("Error guardando plantilla %s: %s", name, e)
            return False

# Uso en PDFExtractor:
def __init__(self, template_repo: TemplateRepository = None):
    self.template_repo = template_repo or TemplateRepository()
    self.plantillas_cargadas = self.template_repo.load_all()
```

**Beneficios:**
- Separaci√≥n clara entre I/O y l√≥gica
- F√°cil mockear en tests
- Preparado para migrar a DB en el futuro
- Single Responsibility Principle

---

### 4.4 Service Layer

**Esfuerzo:** Alto (3-4 horas)
**Impacto:** Muy Alto
**Prioridad:** ‚≠ê‚≠ê MEDIA-ALTA

**Implementaci√≥n:**
```python
# src/services/invoice_extraction_service.py
from typing import List, Dict, Optional
from repositories.template_repository import TemplateRepository
from utils.data_cleaners import DataCleaner
from utils.logger import setup_logger

logger = setup_logger(__name__)

class InvoiceExtractionService:
    """Servicio de extracci√≥n de facturas (l√≥gica de negocio)."""

    def __init__(self,
                 template_repo: TemplateRepository,
                 trimestre: str = "Q1",
                 anio: str = "2025"):
        self.template_repo = template_repo
        self.trimestre = trimestre
        self.anio = anio
        self.cleaner = DataCleaner()

    def process_directory(self, directory: str) -> List[Dict]:
        """
        Procesa todos los PDFs de un directorio.

        Returns:
            Lista de diccionarios con datos extra√≠dos.
        """
        logger.info("Procesando directorio: %s", directory)

        # 1. Listar PDFs
        pdfs = self._list_pdfs(directory)
        logger.info("Encontrados %d PDFs", len(pdfs))

        # 2. Procesar cada PDF
        results = []
        for pdf_path in pdfs:
            result = self.extract_invoice(pdf_path)
            results.append(result)

        # 3. Detectar duplicados
        results = self._mark_duplicates(results)

        return results

    def extract_invoice(self, pdf_path: str) -> Dict:
        """Extrae datos de una factura."""
        # 1. Identificar proveedor
        provider_id = self._identify_provider(pdf_path)

        if not provider_id:
            return self._create_error_invoice(pdf_path, "Proveedor no identificado")

        # 2. Extraer campos
        template = self.template_repo.load_one(provider_id)
        data = self._extract_fields(pdf_path, template)

        # 3. Limpiar datos
        data = self._clean_data(data)

        return data

    def _identify_provider(self, pdf_path: str) -> Optional[str]:
        """Identifica proveedor bas√°ndose en CIF/Nombre."""
        # ... l√≥gica actual de identificar_proveedor()
        pass

    def _extract_fields(self, pdf_path: str, template: dict) -> Dict:
        """Extrae campos seg√∫n plantilla."""
        # ... l√≥gica actual de extraer_datos_factura()
        pass

    def _clean_data(self, data: Dict) -> Dict:
        """Limpia todos los campos."""
        for field, value in data.items():
            if 'Fecha' in field:
                data[field] = self.cleaner.clean_date(value)
            elif field in ['Base', 'ComPaypal']:
                data[field] = self.cleaner.clean_numeric(value)
            else:
                data[field] = self.cleaner.clean_text(value)
        return data

# Uso en main.py:
extraction_service = InvoiceExtractionService(
    template_repo=TemplateRepository(),
    trimestre=trimestre,
    anio=anio
)

resultados = extraction_service.process_directory("facturas/")
```

**Beneficios:**
- main.py mucho m√°s simple (de 320 a ~100 l√≠neas)
- L√≥gica de negocio centralizada y testeada
- F√°cil extender funcionalidades
- Dependency injection natural
- Tests m√°s simples (mockear servicios, no clases grandes)

---

### 4.5 Refactorizar ExcelExporter

**Esfuerzo:** Medio (2-3 horas)
**Impacto:** Medio
**Prioridad:** ‚≠ê BAJA-MEDIA

**Implementaci√≥n Strategy Pattern:**
```python
# src/exporters/base_exporter.py
from abc import ABC, abstractmethod
from typing import List, Dict

class BaseExporter(ABC):
    """Interfaz com√∫n para exportadores."""

    @abstractmethod
    def export(self, data: List[Dict], output_path: str) -> str:
        """Exporta datos a formato espec√≠fico."""
        pass

# src/exporters/excel_exporter.py
from .base_exporter import BaseExporter

class ExcelExporter(BaseExporter):
    def export(self, data: List[Dict], output_path: str) -> str:
        # ... l√≥gica Excel
        pass

# src/exporters/csv_exporter.py
class CSVExporter(BaseExporter):
    def export(self, data: List[Dict], output_path: str) -> str:
        # ... l√≥gica CSV
        pass

# src/exporters/json_exporter.py
class JSONExporter(BaseExporter):
    def export(self, data: List[Dict], output_path: str) -> str:
        # ... l√≥gica JSON
        pass

# src/services/export_service.py
class ExportService:
    """Servicio de exportaci√≥n."""

    def __init__(self):
        self.exporters = {
            'excel': ExcelExporter(),
            'csv': CSVExporter(),
            'json': JSONExporter()
        }

    def export(self, data: List[Dict], format: str, output_dir: str) -> str:
        """Exporta a formato especificado."""
        exporter = self.exporters.get(format)
        if not exporter:
            raise ValueError(f"Formato no soportado: {format}")

        return exporter.export(data, output_dir)
```

**Beneficios:**
- F√°cil a√±adir nuevos formatos (XML, Parquet, etc.)
- C√≥digo m√°s limpio y modular
- Strategy pattern bien implementado
- Tests independientes por exporter

---

## 5. HOJA DE RUTA RECOMENDADA

### Fase A: Mejoras R√°pidas (2-3 horas) - HACER AHORA

```
Semana 1 (2-3 d√≠as)
‚îú‚îÄ‚îÄ Issue #8: Logging estructurado (1h)
‚îÇ   ‚îú‚îÄ‚îÄ Crear src/utils/logger.py
‚îÇ   ‚îú‚îÄ‚îÄ Reemplazar print() en todos los m√≥dulos
‚îÇ   ‚îî‚îÄ‚îÄ Tests: verificar que sigue funcionando
‚îÇ
‚îú‚îÄ‚îÄ Issue #9: Extraer data cleaners (1h)
‚îÇ   ‚îú‚îÄ‚îÄ Crear src/utils/data_cleaners.py
‚îÇ   ‚îú‚îÄ‚îÄ Mover funciones de limpieza
‚îÇ   ‚îú‚îÄ‚îÄ Refactorizar PDFExtractor para usar utils
‚îÇ   ‚îî‚îÄ‚îÄ Tests: a√±adir tests unitarios para cleaners
‚îÇ
‚îî‚îÄ‚îÄ Issue #10: Eliminar duplicaciones (1h)
    ‚îú‚îÄ‚îÄ Consolidar inicializaci√≥n datos_error
    ‚îú‚îÄ‚îÄ Consolidar filtrado de columnas
    ‚îî‚îÄ‚îÄ Tests: verificar coverage >= 79%
```

**ROI:** üü¢ Muy Alto - Bajo esfuerzo, alto beneficio inmediato

---

### Fase B: Repository + Service (4-6 horas) - HACER PR√ìXIMAMENTE

```
Semana 2-3 (4-5 d√≠as)
‚îú‚îÄ‚îÄ Issue #11: TemplateRepository (2h)
‚îÇ   ‚îú‚îÄ‚îÄ Crear src/repositories/template_repository.py
‚îÇ   ‚îú‚îÄ‚îÄ Mover l√≥gica carga plantillas desde PDFExtractor
‚îÇ   ‚îú‚îÄ‚îÄ Tests: a√±adir tests para repository
‚îÇ   ‚îî‚îÄ‚îÄ Refactorizar PDFExtractor para usar repo
‚îÇ
‚îú‚îÄ‚îÄ Issue #12: InvoiceExtractionService (3h)
‚îÇ   ‚îú‚îÄ‚îÄ Crear src/services/invoice_extraction_service.py
‚îÇ   ‚îú‚îÄ‚îÄ Mover l√≥gica extracci√≥n desde PDFExtractor
‚îÇ   ‚îú‚îÄ‚îÄ Tests: a√±adir tests para service
‚îÇ   ‚îî‚îÄ‚îÄ Verificar coverage >= 79%
‚îÇ
‚îî‚îÄ‚îÄ Issue #13: Refactorizar main.py (1h)
    ‚îú‚îÄ‚îÄ Usar InvoiceExtractionService
    ‚îú‚îÄ‚îÄ Simplificar l√≥gica CLI
    ‚îî‚îÄ‚îÄ Tests: actualizar mocks si es necesario
```

**ROI:** üü¢ Alto - Arquitectura profesional, mantenibilidad

---

### Fase C: Mejoras Opcionales (4-6 horas) - CONSIDERAR DESPU√âS

```
Semana 4+ (opcional)
‚îú‚îÄ‚îÄ Issue #14: Dataclasses (2h)
‚îÇ   ‚îú‚îÄ‚îÄ Crear src/models/invoice.py
‚îÇ   ‚îú‚îÄ‚îÄ Crear src/models/template.py
‚îÇ   ‚îî‚îÄ‚îÄ Refactorizar para usar modelos
‚îÇ
‚îî‚îÄ‚îÄ Issue #15: Strategy en Exporters (3h)
    ‚îú‚îÄ‚îÄ Crear src/exporters/base_exporter.py
    ‚îú‚îÄ‚îÄ Separar ExcelExporter, CSVExporter, JSONExporter
    ‚îú‚îÄ‚îÄ Crear ExportService
    ‚îî‚îÄ‚îÄ Tests: verificar todos los formatos
```

**ROI:** üü° Medio - Extensibilidad, no urgente

---

## 6. MATRIZ DE DECISI√ìN

### Cuadrante de Esfuerzo vs Impacto

```
                IMPACTO
                  ‚Üë
        ALTO      ‚îÇ   1. Logging ‚úÖ     ‚îÇ  4. Repository ‚úÖ
                  ‚îÇ   2. DataCleaner ‚úÖ ‚îÇ  5. Service Layer ‚úÖ
                  ‚îÇ                    ‚îÇ
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí ESFUERZO
                  ‚îÇ                    ‚îÇ
        MEDIO     ‚îÇ   3. Elim. Dups ‚úÖ  ‚îÇ  6. Dataclasses
                  ‚îÇ                    ‚îÇ
        BAJO      ‚îÇ   (ya todo cubierto)‚îÇ  7. DI Container
                  ‚îÇ                    ‚îÇ
              BAJO                    ALTO
```

### Recomendaci√≥n de Orden:

1. **Logging** (AHORA) - 1 hora
2. **DataCleaner** (AHORA) - 1 hora
3. **Eliminar duplicaciones** (AHORA) - 1 hora
4. **Repository** (PRONTO) - 2 horas
5. **Service Layer** (PRONTO) - 3 horas
6. **Dataclasses** (DESPU√âS) - 2 horas
7. **Strategy Exporters** (DESPU√âS) - 3 horas

**Total Fase A+B:** 8 horas (inversi√≥n recomendada)
**Total Fase A+B+C:** 13 horas (si tiempo permite)

---

## 7. CRITERIOS DE √âXITO

### M√©tricas Objetivo Post-Refactorizaci√≥n:

| M√©trica | Actual | Objetivo | Status |
|---------|--------|----------|--------|
| **Coverage Total** | 79% | >= 79% (preferible 80%+) | üéØ |
| **Tests Passing** | 154/156 | >= 154/156 | ‚úÖ |
| **Logging Coverage** | 0% (print) | 100% (logger) | üìä |
| **Duplicaci√≥n** | Media | Baja | üìâ |
| **Complejidad main.py** | Alta | Baja | üéØ |
| **Separaci√≥n de Concerns** | Media | Alta | üéØ |

### Indicadores de Calidad:

- ‚úÖ Todos los tests pasando
- ‚úÖ Sin regresiones en funcionalidad
- ‚úÖ Logging en todos los m√≥dulos
- ‚úÖ Responsabilidades claramente separadas
- ‚úÖ C√≥digo m√°s legible y mantenible
- ‚úÖ F√°cil a√±adir nuevas funcionalidades
- ‚úÖ Tests m√°s simples (menos mocks)

---

## 8. RIESGOS Y MITIGACI√ìN

### Riesgo 1: Romper tests existentes

**Probabilidad:** Media
**Impacto:** Alto

**Mitigaci√≥n:**
- Ejecutar tests despu√©s de CADA cambio
- Commits peque√±os y at√≥micos
- Revertir inmediatamente si tests fallan
- TDD estricto: tests primero, c√≥digo despu√©s

---

### Riesgo 2: Bajada de coverage

**Probabilidad:** Baja
**Impacto:** Medio

**Mitigaci√≥n:**
- Monitorear coverage en cada commit
- A√±adir tests para nuevo c√≥digo inmediatamente
- Target: >= 79% en todo momento

---

### Riesgo 3: Over-engineering

**Probabilidad:** Media
**Impacto:** Medio

**Mitigaci√≥n:**
- Seguir principio YAGNI (You Aren't Gonna Need It)
- Solo implementar Fase A + Fase B inicialmente
- Validar Fase C antes de implementar
- Mantener pragmatismo sobre purismo

---

### Riesgo 4: Tiempo de implementaci√≥n mayor al estimado

**Probabilidad:** Media
**Impacto:** Bajo

**Mitigaci√≥n:**
- Fase A es independiente (2-3h garantizadas)
- Fase B puede pausarse si es necesario
- Fase C es completamente opcional
- Beneficio incremental en cada fase

---

## 9. PREGUNTAS FRECUENTES

### ¬øPor qu√© no Clean Architecture completa?

**Respuesta:** Over-engineering. El proyecto es funcional y relativamente peque√±o (4 m√≥dulos, 1079 statements). Clean Architecture completa a√±adir√≠a complejidad innecesaria. La propuesta incremental da 80% del beneficio con 30% del esfuerzo.

---

### ¬øPor qu√© no usar un framework de DI (Dependency Injection)?

**Respuesta:** Dependency injection manual es suficiente. Frameworks como `dependency-injector` a√±aden learning curve y dependencias externas. Para este proyecto, inyecci√≥n manual en constructores es m√°s que suficiente.

---

### ¬øCu√°ndo implementar Fase C?

**Respuesta:** Fase C es opcional. Implementar solo si:
1. Fase A + B est√°n completas y estables
2. Hay necesidad real de a√±adir muchos formatos de exportaci√≥n
3. El proyecto sigue creciendo en complejidad

---

### ¬øQu√© pasa si coverage baja durante refactor?

**Respuesta:**
1. **Stop immediato** - No continuar
2. A√±adir tests para c√≥digo nuevo
3. Si persiste < 79%, revertir cambio
4. Coverage debe mantenerse >= 79%

---

### ¬øC√≥mo testear servicios y repositorios?

**Respuesta:**
```python
# Ejemplo: test repository
def test_template_repository_loads_all(tmp_path):
    # Arrange
    template_dir = tmp_path / "plantillas"
    template_dir.mkdir()
    (template_dir / "test.json").write_text('{"nombre": "test"}')

    repo = TemplateRepository(template_dir)

    # Act
    templates = repo.load_all()

    # Assert
    assert len(templates) == 1
    assert 'test' in templates

# Ejemplo: test service con mock
def test_extraction_service_process_directory(mocker):
    # Arrange
    mock_repo = mocker.Mock()
    service = InvoiceExtractionService(template_repo=mock_repo)

    # Act
    results = service.process_directory("test/")

    # Assert
    assert len(results) > 0
```

---

## 10. CONCLUSI√ìN

### Veredicto Final: **REFACTORIZAR INCREMENTALMENTE ‚úÖ**

**Razones:**
1. **ROI excelente**: 8-10 horas ‚Üí beneficio a largo plazo
2. **Riesgo controlado**: Cambios incrementales y testeados
3. **Pragmatismo**: No over-engineering, solo lo necesario
4. **Valor inmediato**: Cada fase aporta beneficio tangible
5. **Alineado con TDD**: Metodolog√≠a ya establecida

### Pr√≥ximos Pasos:

1. ‚úÖ **Completado**: An√°lisis arquitect√≥nico
2. ‚úÖ **Completado**: Crear ADR-001
3. üîÑ **En progreso**: Crear Issue #7 en GitHub
4. ‚è≥ **Pendiente**: Obtener aprobaci√≥n para Fase A
5. ‚è≥ **Pendiente**: Implementar Fase A (logging, cleaners, dups)

---

**Fecha de an√°lisis:** 2025-10-25
**Pr√≥xima revisi√≥n:** Despu√©s de Fase A (estimado: 3 d√≠as)
**Contacto:** Ver Issue #7 en GitHub

---

## AP√âNDICE A: Gr√°fico de Dependencias Actual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  main.py                          ‚îÇ
‚îÇ           (FacturaExtractorApp)                   ‚îÇ
‚îÇ  - CLI parsing                                    ‚îÇ
‚îÇ  - Validaci√≥n de inputs                           ‚îÇ
‚îÇ  - Orquestaci√≥n del flujo                         ‚îÇ
‚îÇ  - Mostrar estad√≠sticas                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ                  ‚îÇ
            ‚îÇ                  ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ PDFExtractor    ‚îÇ  ‚îÇ  ExcelExporter     ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îÇ - Cargar JSON   ‚îÇ  ‚îÇ - Excel b√°sico     ‚îÇ
    ‚îÇ - Validar       ‚îÇ  ‚îÇ - Excel completo   ‚îÇ
    ‚îÇ - Identificar   ‚îÇ  ‚îÇ - Excel formateado ‚îÇ
    ‚îÇ - Extraer       ‚îÇ  ‚îÇ - CSV              ‚îÇ
    ‚îÇ - Limpiar       ‚îÇ  ‚îÇ - JSON             ‚îÇ
    ‚îÇ - Duplicados    ‚îÇ  ‚îÇ - Filtrar cols     ‚îÇ
    ‚îÇ - Stats         ‚îÇ  ‚îÇ - Stats            ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ                  ‚îÇ
            ‚îÇ                  ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ      Librer√≠as Externas          ‚îÇ
    ‚îÇ  - pdfplumber (PDF parsing)      ‚îÇ
    ‚îÇ  - pandas (data manipulation)    ‚îÇ
    ‚îÇ  - openpyxl (Excel writing)      ‚îÇ
    ‚îÇ  - PIL (imagen en GUI)           ‚îÇ
    ‚îÇ  - tkinter (GUI plantillas)      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## AP√âNDICE B: Gr√°fico de Dependencias Objetivo (Post-Refactor)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  main.py                          ‚îÇ
‚îÇ           (FacturaExtractorApp)                   ‚îÇ
‚îÇ  - CLI parsing                                    ‚îÇ
‚îÇ  - Orquestaci√≥n simple                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚îÇ                  ‚îÇ
            ‚îÇ                  ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ InvoiceExtraction   ‚îÇ  ‚îÇ  ExportService     ‚îÇ
    ‚îÇ Service             ‚îÇ  ‚îÇ                    ‚îÇ
    ‚îÇ (L√≥gica de negocio) ‚îÇ  ‚îÇ (Exportaci√≥n)      ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                      ‚îÇ
         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ  ‚îÇ                          ‚îÇ          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Template       ‚îÇ   ‚îÇ Excel          ‚îÇ  ‚îÇ CSV     ‚îÇ
    ‚îÇ Repository     ‚îÇ   ‚îÇ Exporter       ‚îÇ  ‚îÇ Exporter‚îÇ
    ‚îÇ (I/O)          ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ utils/                  ‚îÇ
    ‚îÇ  - logger.py            ‚îÇ
    ‚îÇ  - data_cleaners.py     ‚îÇ
    ‚îÇ  - validators.py        ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Mejoras visibles:**
- ‚úÖ main.py mucho m√°s simple
- ‚úÖ Servicios con responsabilidades claras
- ‚úÖ Repository para I/O separado
- ‚úÖ Utils reutilizables
- ‚úÖ Exporters modulares (Strategy)

---

**FIN DEL AN√ÅLISIS**
